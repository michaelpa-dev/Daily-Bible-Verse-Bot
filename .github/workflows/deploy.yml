name: Deploy Bot

on:
  push:
    branches:
      - master
      - canary
  workflow_dispatch:
    inputs:
      target_environment:
        description: Deployment target environment
        required: true
        type: choice
        default: canary
        options:
          - canary
          - production

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  resolve-target:
    name: Resolve deployment target
    runs-on: ubuntu-latest
    needs: test
    outputs:
      should_deploy: ${{ steps.resolve.outputs.should_deploy }}
      environment: ${{ steps.resolve.outputs.environment }}
      git_ref: ${{ steps.resolve.outputs.git_ref }}
    steps:
      - name: Resolve
        id: resolve
        env:
          EVENT_NAME: ${{ github.event_name }}
          GIT_REF: ${{ github.ref }}
          INPUT_TARGET_ENVIRONMENT: ${{ github.event.inputs.target_environment }}
        run: |
          set -euo pipefail

          should_deploy=false
          environment=""
          git_ref=""

          if [ "${EVENT_NAME}" = "push" ]; then
            if [ "${GIT_REF}" = "refs/heads/master" ]; then
              should_deploy=true
              environment="production"
              git_ref="master"
            elif [ "${GIT_REF}" = "refs/heads/canary" ]; then
              should_deploy=true
              environment="canary"
              git_ref="canary"
            fi
          elif [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            should_deploy=true
            environment="${INPUT_TARGET_ENVIRONMENT}"
            if [ "${environment}" = "production" ]; then
              git_ref="master"
            else
              git_ref="canary"
            fi
          fi

          echo "should_deploy=${should_deploy}" >> "$GITHUB_OUTPUT"
          echo "environment=${environment}" >> "$GITHUB_OUTPUT"
          echo "git_ref=${git_ref}" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy (${{ needs.resolve-target.outputs.environment }})
    runs-on: ubuntu-latest
    needs: resolve-target
    if: needs.resolve-target.outputs.should_deploy == 'true'
    environment: ${{ needs.resolve-target.outputs.environment }}
    steps:
      - name: Validate required deployment secrets
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          set -euo pipefail
          missing=()

          [ -n "${DEPLOY_HOST}" ] || missing+=("DEPLOY_HOST")
          [ -n "${DEPLOY_USER}" ] || missing+=("DEPLOY_USER")
          [ -n "${DEPLOY_PATH}" ] || missing+=("DEPLOY_PATH")
          [ -n "${DEPLOY_SSH_KEY}" ] || missing+=("DEPLOY_SSH_KEY")
          [ -n "${BOT_TOKEN}" ] || missing+=("BOT_TOKEN")

          if [ "${#missing[@]}" -gt 0 ]; then
            echo "Missing one or more required secrets: ${missing[*]}"
            exit 1
          fi

      - name: Notify Discord (deploy started)
        continue-on-error: true
        env:
          DISCORD_DEPLOY_WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}
          DEPLOY_ENVIRONMENT: ${{ needs.resolve-target.outputs.environment }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ needs.resolve-target.outputs.git_ref }}
          COMMIT_SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_DEPLOY_WEBHOOK_URL}" ]; then
            echo "DISCORD_DEPLOY_WEBHOOK_URL is not configured. Skipping notification."
            exit 0
          fi
          python - <<'PY'
          import json
          import os
          import urllib.request

          message = (
              f"Deploy started ({os.environ['DEPLOY_ENVIRONMENT']}) for {os.environ['REPO']} on branch {os.environ['BRANCH']}.\n"
              f"Commit: {os.environ['COMMIT_SHA']}\n"
              f"Run: {os.environ['RUN_URL']}"
          )
          payload = json.dumps({"content": message}).encode("utf-8")
          request = urllib.request.Request(
              os.environ["DISCORD_DEPLOY_WEBHOOK_URL"],
              data=payload,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          urllib.request.urlopen(request).read()
          PY

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Trust deploy host key
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          set -euo pipefail
          PORT="${DEPLOY_PORT:-22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "${PORT}" -H "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Deploy on server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          REPOSITORY: ${{ github.repository }}
          DEPLOY_GIT_REF: ${{ needs.resolve-target.outputs.git_ref }}
          DEPLOY_ENVIRONMENT: ${{ needs.resolve-target.outputs.environment }}
          GIT_SHA: ${{ github.sha }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          set -euo pipefail
          PORT="${DEPLOY_PORT:-22}"
          BOT_TOKEN_B64="$(printf '%s' "${BOT_TOKEN}" | base64 | tr -d '\n')"
          echo "::add-mask::${BOT_TOKEN}"
          echo "::add-mask::${BOT_TOKEN_B64}"

          ssh -p "${PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" "
            set -euo pipefail
            mkdir -p \"${DEPLOY_PATH}\"
            cd \"${DEPLOY_PATH}\"
            if [ ! -d .git ]; then
              git init
              if git remote get-url origin >/dev/null 2>&1; then
                git remote set-url origin \"https://github.com/${REPOSITORY}.git\"
              else
                git remote add origin \"https://github.com/${REPOSITORY}.git\"
              fi
            fi

            git fetch origin \"${DEPLOY_GIT_REF}\" --prune
            git checkout -B \"${DEPLOY_GIT_REF}\" \"origin/${DEPLOY_GIT_REF}\"
            mkdir -p db logs logs/archive

            if [ ! -f .env ]; then
              echo \"Missing ${DEPLOY_PATH}/.env file with runtime secrets (excluding BOT_TOKEN).\"
              exit 1
            fi

            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE=\"docker compose\"
            elif command -v docker-compose >/dev/null 2>&1; then
              DOCKER_COMPOSE=\"docker-compose\"
            else
              echo \"Docker Compose not found on host\"
              exit 1
            fi

            BOT_TOKEN=\"\$(printf '%s' '${BOT_TOKEN_B64}' | base64 -d)\"
            export BOT_TOKEN
            export DEPLOY_ENVIRONMENT=\"${DEPLOY_ENVIRONMENT}\"
            export GIT_SHA=\"${GIT_SHA}\"

            \$DOCKER_COMPOSE -f docker-compose.prod.yml up -d --build --remove-orphans
            \$DOCKER_COMPOSE -f docker-compose.prod.yml ps
            docker image prune -f
          "

      - name: Notify Discord (deploy success)
        if: ${{ success() }}
        continue-on-error: true
        env:
          DISCORD_DEPLOY_WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}
          DEPLOY_ENVIRONMENT: ${{ needs.resolve-target.outputs.environment }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ needs.resolve-target.outputs.git_ref }}
          COMMIT_SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_DEPLOY_WEBHOOK_URL}" ]; then
            echo "DISCORD_DEPLOY_WEBHOOK_URL is not configured. Skipping notification."
            exit 0
          fi
          python - <<'PY'
          import json
          import os
          import urllib.request

          message = (
              f"Deploy succeeded ({os.environ['DEPLOY_ENVIRONMENT']}) for {os.environ['REPO']} on branch {os.environ['BRANCH']}.\n"
              f"Commit: {os.environ['COMMIT_SHA']}\n"
              f"Run: {os.environ['RUN_URL']}"
          )
          payload = json.dumps({"content": message}).encode("utf-8")
          request = urllib.request.Request(
              os.environ["DISCORD_DEPLOY_WEBHOOK_URL"],
              data=payload,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          urllib.request.urlopen(request).read()
          PY

      - name: Notify Discord (deploy failed)
        if: ${{ failure() }}
        continue-on-error: true
        env:
          DISCORD_DEPLOY_WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}
          DEPLOY_ENVIRONMENT: ${{ needs.resolve-target.outputs.environment }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ needs.resolve-target.outputs.git_ref }}
          COMMIT_SHA: ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_DEPLOY_WEBHOOK_URL}" ]; then
            echo "DISCORD_DEPLOY_WEBHOOK_URL is not configured. Skipping notification."
            exit 0
          fi
          python - <<'PY'
          import json
          import os
          import urllib.request

          message = (
              f"Deploy failed ({os.environ['DEPLOY_ENVIRONMENT']}) for {os.environ['REPO']} on branch {os.environ['BRANCH']}.\n"
              f"Commit: {os.environ['COMMIT_SHA']}\n"
              f"Run: {os.environ['RUN_URL']}"
          )
          payload = json.dumps({"content": message}).encode("utf-8")
          request = urllib.request.Request(
              os.environ["DISCORD_DEPLOY_WEBHOOK_URL"],
              data=payload,
              headers={"Content-Type": "application/json"},
              method="POST",
          )
          urllib.request.urlopen(request).read()
          PY
