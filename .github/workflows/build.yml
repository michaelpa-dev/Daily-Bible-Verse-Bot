name: Build and Release

on:
  push:
    branches:
      - canary
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build + Package + Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          prerelease="true"
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            release_tag="${GITHUB_REF#refs/tags/}"
            prerelease="false"
            release_name="Daily Bible Verse Bot ${release_tag}"
          else
            release_tag="canary-${GITHUB_SHA}"
            short_sha="${GITHUB_SHA::7}"
            release_name="Canary ${short_sha}"
          fi

          asset_name="daily-bible-verse-bot-${release_tag}.tar.gz"

          echo "release_tag=${release_tag}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${prerelease}" >> "$GITHUB_OUTPUT"
          echo "release_name=${release_name}" >> "$GITHUB_OUTPUT"
          echo "asset_name=${asset_name}" >> "$GITHUB_OUTPUT"

      - name: Package release artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail

          asset_name="${{ steps.meta.outputs.asset_name }}"

          # Keep the artifact small and deterministic.
          tar -czf "${asset_name}" \
            Dockerfile \
            docker-compose.prod.yml \
            package.json \
            package-lock.json \
            readme.md \
            assets \
            cfg/config-sample.json \
            docs \
            js \
            scripts

          echo "asset_path=${asset_name}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release (upload asset)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.release_tag }}
          name: ${{ steps.meta.outputs.release_name }}
          prerelease: ${{ steps.meta.outputs.prerelease }}
          generate_release_notes: true
          files: ${{ steps.package.outputs.asset_path }}
